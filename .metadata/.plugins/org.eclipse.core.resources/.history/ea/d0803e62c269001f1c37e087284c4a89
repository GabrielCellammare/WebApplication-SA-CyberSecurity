package application.util.fileChecker;

import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;

import javax.servlet.ServletContext;
import javax.servlet.http.Part;

import org.apache.tika.Tika;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;

import application.util.cryptography.Encryption;
import application.util.customMessage.DisplayMessage;

public class ProposalChecker {

	public static boolean checkProposalFile(Part filePart, ServletContext context) throws IOException {
		// Controlla se il file è stato effettivamente caricato
		if (filePart != null && filePart.getSize() > 0) {
			// Ottieni il nome del file
			String fileName = Paths.get(filePart.getSubmittedFileName()).getFileName().toString();

			System.out.println("fileName: " + fileName);
			// Controlla l'estensione del file
			String fileExtension = fileName.substring(fileName.lastIndexOf(".") + 1).toLowerCase();
			if ("txt".equals(fileExtension)) {

				String realPath = context.getRealPath("/");
				Path filePath = Paths.get(realPath, fileName);
				System.out.println("filePath: " + filePath);

				return true;
			} else {
				// L'estensione del file non è ".txt"
				DisplayMessage.showPanel("Puoi caricare solo file di testo in formato txt!");
			}
		} else {
			// Nessun file caricato
			DisplayMessage.showPanel("Devi caricare una proposta progettuale!");
		}
		// Se si arriva qui, qualcosa è andato storto, restituisci false
		return false;
	}

	public static String processFile(Part filePart,byte[] checksumOriginal) {


		long maxSizeInBytes = 10 * 1024 * 1024; //Max 10MB
		if (filePart.getSize() > maxSizeInBytes) {
			DisplayMessage.showPanel(
					"Il file supera la dimensione massima consentita. Il file puo' essere massimo di 10 MB");
			return null;
		}

		// Usa try-with-resources per gestire la chiusura dell'input stream
		try (InputStream inputStream = filePart.getInputStream()) {
			byte[] fileContent = inputStream.readAllBytes();
			boolean check = false;
			byte[] lastChecksum = Encryption.calculateChecksumFile(fileContent);

			check=Arrays.equals(checksumOriginal, lastChecksum);

			if(!check) {
				DisplayMessage.showPanel("Non è stato possibile terminare il processo di verifica, i file non risultano uguali!");
				return null; 
			}
		}
		try(InputStream inputStream = filePart.getInputStream()){
			// Controlla il content-type con Tika
			Tika tika = new Tika();
			String contentType = tika.detect(inputStream);
			System.out.println(contentType);

			// Riposizionare l'InputStream se necessario (ricreare perché tika.detect() consuma inputStream)
			if ("text/plain".equals(contentType) || "text/html".equals(contentType)) {
				// Crea un nuovo InputStream per leggere di nuovo i dati
				try (InputStream fileContentStream = filePart.getInputStream()) {
					byte[] contentBytes = fileContentStream.readAllBytes();
					String content = new String(contentBytes, StandardCharsets.UTF_8);

					// Usa Jsoup per rimuovere gli script JavaScript
					Document document = Jsoup.parse(content);
					document.select("script, [type=application/javascript], [type=text/javascript]").remove();
					document.select("[text]").unwrap(); // Rimuove anche il testo all'interno dei tag script

					document.select("[onclick]").removeAttr("onclick");
					document.select("[onload]").removeAttr("onload");

					String cleanedHtml = document.toString();

					checksumOriginal = Encryption.calculateChecksumFile(cleanedHtml.getBytes(StandardCharsets.UTF_8));
					return cleanedHtml;
				}
			} else {
				DisplayMessage.showPanel("Il file contiene del testo non valido!");
				return null;
			}
		} catch (IOException e) {
			e.printStackTrace();
			DisplayMessage.showPanel("C'è stato un problema con il caricamento del file!");
			return null;
		}
	}


	private static String getFileNameFromPath(String filePath) {
		Path path = Paths.get(filePath);
		return path.getFileName().toString();
	}

	public static String getFileName(Part part) {
		String contentDisposition = part.getHeader("content-disposition");
		String[] tokens = contentDisposition.split(";");
		for (String token : tokens) {
			if (token.trim().startsWith("filename")) {
				// Ottieni solo il nome del file dal percorso completo
				String fileNameWithExtension = token.substring(token.indexOf('=') + 1).trim().replace("\"", "");
				return getFileNameFromPath(fileNameWithExtension);
			}
		}
		return "";
	}	

}

